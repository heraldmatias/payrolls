<?php

namespace Inei\Bundle\PayrollBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * FoliosRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FoliosRepository extends EntityRepository {

    public function findCustomBy($criteria) {
        $DQL = "
            SELECT t.codiTomo as tomo, f.codiFolio, f.folio, pla.descTipoTpl, f.periodoFolio, f.registrosFolio, f.subtPlanStp
            FROM IneiPayrollBundle:Folios f
            JOIN f.tomo t
            LEFT JOIN f.tipoPlanTpl pla
        ";
        $where = array();
        if (array_key_exists('tomo', $criteria))
            $where[] = 't.codiTomo =' . $criteria['tomo'];
        if (array_key_exists('folio', $criteria))
            $where[] = 'f.folio =' . $criteria['folio'];
        if (array_key_exists('periodoFolio', $criteria))
            $where[] = "f.periodoFolio ='" . $criteria['periodoFolio'] . "'";
        if (array_key_exists('registrosFolio', $criteria))
            $where[] = 'f.registrosFolio =' . $criteria['registrosFolio'];
        $DQL .= count($where) > 0 ? ' WHERE ' . implode(' AND ', $where) : '';
        $qb = $this->getEntityManager()->createQuery($DQL);
        return $qb->getResult();
    }

    public function findOneCustomBy($criteria) {
        $folio = $this->findOneBy($criteria);
        if ($folio) {
            $qb = $this->getEntityManager()->createQuery(
                            "SELECT s.descSubtStp FROM IneiPayrollBundle:Subtplanilla s 
                        WHERE s.subtPlanStp = :subt AND s.tipoPlanTpl = :pla ")
                    ->setParameters(array(
                'subt' => $folio->getSubtPlanStp(),
                'pla' => $folio->getTipoPlanTpl()->getTipoPlanTpl(),
            ));
            $re = $qb->getResult();
            if ($re) {
                $subt = $qb->getResult()[0]['descSubtStp'];
                $folio->setDescSubtStp($subt);
            }
        }
        return $folio;
    }

}
